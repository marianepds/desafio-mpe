using Microsoft.AspNetCore.Mvc;          
using Microsoft.EntityFrameworkCore;    
using LocationApi.Data;                 
using LocationApi.Models;               

namespace LocationApi.Controllers
{
    [Route("api/[controller]")]
    
    [ApiController] // validacoes automaticas
    
    public class LocationsController : ControllerBase
    {
        private readonly AppDbContext _context; // recebe o db automaticamente

        public LocationsController(AppDbContext context) // asp injeta db
        {
            _context = context; 
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<LocationResponseDto>>> GetLocations(
            [FromQuery] string? search = null,    // ?search=parque
            [FromQuery] int page = 1,             // ?page=2
            [FromQuery] int pageSize = 20)        // ?pageSize=50
        {
            var query = _context.Locations.AsQueryable();

            if (!string.IsNullOrEmpty(search)) // filtro pra busca se tiver nome
            {
                query = query.Where(l => l.Name.Contains(search));
            }

            var totalItems = await query.CountAsync(); // contagem pra paginação
            var totalPages = (int)Math.Ceiling(totalItems / (double)pageSize); // calcula o total de paginas
            page = Math.Max(1, Math.Min(page, totalPages));

            var locations = await query
                .OrderBy(l => l.Name)                     // ordena por nome A-Z
                .Skip((page - 1) * pageSize)              // pula itens das páginas anteriores
                .Take(pageSize)                           // pega apenas pageSize itens
                
                .Select(l => new LocationResponseDto
                {
                    Id = l.Id,
                    Name = l.Name,
                    Latitude = l.Latitude,
                    Longitude = l.Longitude,
                    Description = l.Description,
                    CreatedAt = l.CreatedAt,
                    UpdatedAt = l.UpdatedAt
                })
                .ToListAsync(); // executa a query no banco

            // headers de paginação
            Response.Headers.Append("X-Total-Count", totalItems.ToString());
            Response.Headers.Append("X-Total-Pages", totalPages.ToString());
            Response.Headers.Append("X-Current-Page", page.ToString());
            Response.Headers.Append("X-Page-Size", pageSize.ToString());

            return Ok(locations);
        }


        [HttpGet("{id}")] // uma localização por id
        public async Task<ActionResult<LocationResponseDto>> GetLocation(int id)
        {
            
            var location = await _context.Locations.FindAsync(id);

            if (location == null)
            {
                return NotFound(new { 
                    message = $"Localização com ID {id} não encontrada." 
                });
            }

            // conversao p dto de resposta
            var locationDto = new LocationResponseDto
            {
                Id = location.Id,
                Name = location.Name,
                Latitude = location.Latitude,
                Longitude = location.Longitude,
                Description = location.Description,
                CreatedAt = location.CreatedAt,
                UpdatedAt = location.UpdatedAt
            };

            return Ok(locationDto);
        }

        [HttpPost] // cria nova localização
        public async Task<ActionResult<LocationResponseDto>> CreateLocation(
            [FromBody] CreateLocationDto createDto)  // dados no corpo da req
        {
            // converte dto pra model
            var location = new Location
            {
                Name = createDto.Name,
                Latitude = createDto.Latitude,
                Longitude = createDto.Longitude,
                Description = createDto.Description,
                CreatedAt = DateTime.UtcNow,      
                UpdatedAt = DateTime.UtcNow       
            };


            _context.Locations.Add(location);
            await _context.SaveChangesAsync();

            // conversao p dto de resposta
            var locationDto = new LocationResponseDto
            {
                Id = location.Id,                    // id gerado pelo banco
                Name = location.Name,
                Latitude = location.Latitude,
                Longitude = location.Longitude,
                Description = location.Description,
                CreatedAt = location.CreatedAt,
                UpdatedAt = location.UpdatedAt
            };

            return CreatedAtAction(
                nameof(GetLocation),                 
                new { id = location.Id },           
                locationDto);                      
        }

        [HttpPut("{id}")] // atualiza uma loc que existe
        public async Task<IActionResult> UpdateLocation(
            int id, 
            [FromBody] UpdateLocationDto updateDto)
        {
            // busca loc pelo id
            var location = await _context.Locations.FindAsync(id);
            if (location == null)
            {
                return NotFound(new { 
                    message = $"Localização com ID {id} não encontrada." 
                });
            }
            
            if (!string.IsNullOrEmpty(updateDto.Name)) // atualiza todos os campos
                location.Name = updateDto.Name;
            
            if (updateDto.Latitude.HasValue)
                location.Latitude = updateDto.Latitude.Value;
            
            if (updateDto.Longitude.HasValue)
                location.Longitude = updateDto.Longitude.Value;
            
            if (updateDto.Description != null)  // opcional, pode string vazia
                location.Description = updateDto.Description;

            // atualiza data de mod
            location.UpdatedAt = DateTime.UtcNow;

            try
            {
                // salva alterações do update
                await _context.SaveChangesAsync();
            }
            catch (DbUpdateConcurrencyException)
            {
                // verifica se ainda existe
                if (!LocationExists(id))
                {
                    return NotFound();
                }
                else
                {
                    throw; 
                }
            }
            return NoContent();
        }

        // deleta uma loc
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteLocation(int id)
        {
            var location = await _context.Locations.FindAsync(id);
            if (location == null)
            {
                return NotFound(new { 
                    message = $"Localização com ID {id} não encontrada." 
                });
            }
            _context.Locations.Remove(location);
            await _context.SaveChangesAsync();

            return NoContent();
        }

// verifica se loc existe
        private bool LocationExists(int id)
        {
            return _context.Locations.Any(e => e.Id == id);
        }
    }
}